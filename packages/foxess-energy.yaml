# packages/foxess-energy.yaml
# Minimalna konfiguracja TYLKO do panelu Energia (PV + bateria + sieć + dom)
# FoxESS P3 – Modbus TCP

modbus:
  - name: foxess_p3
    type: tcp
    host: 192.168.1.100
    port: 502
    timeout: 5
    delay: 0
    message_wait_milliseconds: 30

    sensors:
      # PV – całkowita i dzienna energia + moc chwilowa
      - name: PV Total Energy
        slave: 247
        address: 39601
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        precision: 2
        scan_interval: 300

      - name: PV Daily Energy
        slave: 247
        address: 39603
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        precision: 2
        scan_interval: 300

      - name: PV Power
        slave: 247
        address: 39118
        data_type: int32
        scale: 0.001
        unit_of_measurement: kW
        device_class: power
        state_class: measurement
        precision: 3
        scan_interval: 5

      # Bateria – SoC + pozostała energia + moc
      - name: Battery SoC
        slave: 247
        address: 37612
        data_type: uint16
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        precision: 0
        scan_interval: 10

      - name: Battery Remaining Energy
        slave: 247
        address: 37632
        data_type: uint16
        scale: 0.001
        unit_of_measurement: kWh
        device_class: energy
        state_class: measurement
        precision: 2
        scan_interval: 60

      - name: Battery Power
        slave: 247
        address: 39230
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        precision: 0
        scan_interval: 5

      # Sieć i dom – moc chwilowa
      - name: Grid Power
        slave: 247
        address: 38814
        data_type: int32
        scale: 0.1
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        precision: 1
        scan_interval: 5

      - name: Home Power
        slave: 247
        address: 39225
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        precision: 0
        scan_interval: 5

template:
  - sensor:
      - name: Grid Import Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.grid_power') | float(0) * -1) | round(0) }}"

      - name: Grid Export Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.grid_power') | float(0)) | round(0) }}"

      - name: Battery Charge Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.battery_power') | float(0)) | round(0) }}"

      - name: Battery Discharge Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.battery_power') | float(0) * -1) | round(0) }}"

riemann:
  - name: Grid Imported Energy
    source: sensor.grid_import_power
    unit_of_measurement: kWh
    device_class: energy
    state_class: total_increasing
    time_window: 3600
    round: 2

  - name: Grid Exported Energy
    source: sensor.grid_export_power
    unit_of_measurement: kWh
    device_class: energy
    state_class: total_increasing
    time_window: 3600
    round: 2

  - name: Home Consumption Energy
    source: sensor.home_power
    unit_of_measurement: kWh
    device_class: energy
    state_class: total_increasing
    time_window: 3600
    round: 2

  - name: Battery Charged Energy
    source: sensor.battery_charge_power
    unit_of_measurement: kWh
    device_class: energy
    state_class: total_increasing
    time_window: 3600
    round: 2

  - name: Battery Discharged Energy
    source: sensor.battery_discharge_power
    unit_of_measurement: kWh
    device_class: energy
    state_class: total_increasing
    time_window: 3600
    round: 2

utility_meter:
  pv_production_daily:
    source: sensor.pv_total_energy
    cycle: daily

  grid_import_daily:
    source: sensor.grid_imported_energy
    cycle: daily

  grid_export_daily:
    source: sensor.grid_exported_energy
    cycle: daily

  home_consumption_daily:
    source: sensor.home_consumption_energy
    cycle: daily

  battery_charge_daily:
    source: sensor.battery_charged_energy
    cycle: daily

  battery_discharge_daily:
    source: sensor.battery_discharged_energy
    cycle: daily
