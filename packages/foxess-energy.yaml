# packages/foxess-energy.yaml
# Minimalna konfiguracja Modbus + Riemann tylko do panelu Energia w HA
# FoxESS P3 – Modbus TCP
# Używa bezpośrednich rejestrów kumulacyjnych (39601+), gdzie to możliwe
# Dla grid (brak kumulacyjnego w PDF) – Riemann z mocy chwilowej

modbus:
  - name: foxess_p3
    type: tcp
    host: 192.168.1.100
    port: 502
    timeout: 5
    delay: 0
    message_wait_milliseconds: 30

    sensors:
      # PRODUKCJA PV – bezpośrednie rejestry kumulacyjne (39601 total, 39603 daily)
      - name: PV Total Energy
        slave: 247
        address: 39601
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        precision: 2
        scan_interval: 300

      - name: PV Daily Energy
        slave: 247
        address: 39603
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        precision: 2
        scan_interval: 300

      # Moc PV chwilowa – do power flow (39118 total power kW)
      - name: PV Power
        slave: 247
        address: 39118
        data_type: int32
        scale: 0.001
        unit_of_measurement: kW
        device_class: power
        state_class: measurement
        precision: 3
        scan_interval: 5

      # BATERIA – SoC + kumulacyjna energia charge/discharge (39605 charge total, 39609 discharge total)
      - name: Battery SoC
        slave: 247
        address: 37612
        data_type: uint16
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        precision: 0
        scan_interval: 10

      - name: Battery Remaining Energy
        slave: 247
        address: 37632
        data_type: uint16
        scale: 0.001
        unit_of_measurement: kWh
        device_class: energy
        state_class: measurement
        precision: 2
        scan_interval: 60

      - name: Battery Charge Total Energy
        slave: 247
        address: 39605
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        precision: 2
        scan_interval: 300

      - name: Battery Discharge Total Energy
        slave: 247
        address: 39609
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        precision: 2
        scan_interval: 300

      # Moc baterii chwilowa – do power flow (39230 Battery1 Power W)
      - name: Battery Power
        slave: 247
        address: 39230
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        precision: 0
        scan_interval: 5

      # SIEĆ – moc chwilowa (38814 Combined Active Power W) – do Riemann
      - name: Grid Power
        slave: 247
        address: 38814
        data_type: int32
        scale: 0.1
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        precision: 1
        scan_interval: 5

      # ZUŻYCIE DOMU – kumulacyjne (39629 Load Energy Total kWh) + moc chwilowa
      - name: Home Total Energy
        slave: 247
        address: 39629
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        device_class: energy
        state_class: total_increasing
        precision: 2
        scan_interval: 300

      - name: Home Power
        slave: 247
        address: 39225
        data_type: int32
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        precision: 0
        scan_interval: 5

template:
  - sensor:
      - name: Grid Import Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.grid_power') | float(0) * -1) | round(0) }}"

      - name: Grid Export Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.grid_power') | float(0)) | round(0) }}"

      - name: Battery Charge Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.battery_power') | float(0)) | round(0) }}"

      - name: Battery Discharge Power
        unit_of_measurement: W
        device_class: power
        state_class: measurement
        state: "{{ max(0, states('sensor.battery_power') | float(0) * -1) | round(0) }}"

riemann:
  - name: Grid Imported Energy
    source: sensor.grid_import_power
    unit_of_measurement: kWh
    device_class: energy
    state_class: total_increasing
    time_window: 3600
    round: 2

  - name: Grid Exported Energy
    source: sensor.grid_export_power
    unit_of_measurement: kWh
    device_class: energy
    state_class: total_increasing
    time_window: 3600
    round: 2

utility_meter:
  pv_production_daily:
    source: sensor.pv_total_energy
    cycle: daily

  grid_import_daily:
    source: sensor.grid_imported_energy
    cycle: daily

  grid_export_daily:
    source: sensor.grid_exported_energy
    cycle: daily

  home_consumption_daily:
    source: sensor.home_total_energy
    cycle: daily

  battery_charge_daily:
    source: sensor.battery_charge_total_energy
    cycle: daily

  battery_discharge_daily:
    source: sensor.battery_discharge_total_energy
    cycle: daily
