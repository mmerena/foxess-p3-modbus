# foxess-p3.yaml
# Pełna konfiguracja ESPHome dla FoxESS P3-10.0-SH (Modbus TCP + RW time periods)
# Dokument: FOX commercial inverter Modbus V1.05.03.00 (2025-01-15)
# Slave ID: 247 (przetestuj 1 jeśli timeout)
# IP inwertera: zmień poniżej

esphome:
  name: foxess-p3-modbus
  friendly_name: FoxESS P3-10.0-SH Modbus
  platform: ESP32
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

logger:
  level: INFO   # DEBUG do testów zapisu Modbus

api:
  encryption:
    key: "WYGENERUJ_KLUCZ_W_ESPHome_DASHBOARD"

ota:
  platform: esphome
  password: !secret ota_password

time:
  - platform: homeassistant
    id: homeassistant_time

# Modbus TCP
modbus:
  id: modbus_fox
  send_wait_time: 50ms

modbus_controller:
  - id: foxess_p3
    address: 247
    modbus_id: modbus_fox
    command_throttle: 150ms
    setup_priority: -10

# ────────────────────────────────────────────────
# SENSORY RO – kluczowe z PDF
# ────────────────────────────────────────────────

sensor:
  # Model i wersje
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "FoxESS Model Name"
    register_type: holding
    address: 30000
    value_type: STRING
    raw_encode: HEXBYTES
    length: 16
    update_interval: 300s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "FoxESS Serial Number"
    register_type: holding
    address: 30016
    value_type: STRING
    raw_encode: HEXBYTES
    length: 16
    update_interval: 300s

  # BMS1 – podstawowe + kluczowe
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Connection Status"
    register_type: holding
    address: 37002
    value_type: U_WORD
    update_interval: 30s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Voltage"
    register_type: holding
    address: 37609
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Current"
    register_type: holding
    address: 37610
    value_type: S_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 SoC"
    register_type: holding
    address: 37612
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 SOH"
    register_type: holding
    address: 37624
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Remain Energy"
    register_type: holding
    address: 37632
    value_type: U_WORD
    unit_of_measurement: "Wh"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 60s

  # BMS2 – podstawowe
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS2 Voltage"
    register_type: holding
    address: 38307
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS2 SoC"
    register_type: holding
    address: 38310
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 10s

  # Meter1/CT1 – grid trójfazowy
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Grid R Phase Voltage"
    register_type: holding
    address: 38802
    value_type: S_DWORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 5s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Grid Combined Active Power"
    register_type: holding
    address: 38814
    value_type: S_DWORD
    unit_of_measurement: "W"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 5s

  # PV – przykładowo 4 stringi + total
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Number of PV Strings"
    register_type: holding
    address: 39051
    value_type: U_WORD
    update_interval: 300s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV1 Voltage"
    register_type: holding
    address: 39070
    value_type: S_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV1 Current"
    register_type: holding
    address: 39071
    value_type: S_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Total PV Input Power"
    register_type: holding
    address: 39118
    value_type: S_DWORD
    unit_of_measurement: "kW"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    update_interval: 5s

  # Inwerter / Load / EPS
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Inverter Active Power"
    register_type: holding
    address: 39134
    value_type: S_DWORD
    unit_of_measurement: "kW"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    update_interval: 5s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Load Combined Power"
    register_type: holding
    address: 39225
    value_type: S_DWORD
    unit_of_measurement: "W"
    accuracy_decimals: 0
    update_interval: 5s

  # Energie kumulacyjne
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Cumulative Power Generation"
    register_type: holding
    address: 39149
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Total PV Energy"
    register_type: holding
    address: 39601
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 300s

# ────────────────────────────────────────────────
# RW – TIME PERIODS (6 grup) + Time Mode Enable
# ────────────────────────────────────────────────

# Switch – włącz/wyłącz cały tryb czasowy
switch:
  - platform: template
    name: "Time Mode Enable"
    id: time_mode_enable
    icon: "mdi:clock"
    optimistic: true
    turn_on_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48000, 1);
    turn_off_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48000, 0);

# Numbers – pełne 6 grup czasowych
number:
  # Time Group 1
  - platform: template
    name: "Time Group 1 - Start Hour"
    id: time_group_1_start_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48010, x);

  - platform: template
    name: "Time Group 1 - Start Minute"
    id: time_group_1_start_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48011, x);

  - platform: template
    name: "Time Group 1 - End Hour"
    id: time_group_1_end_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48012, x);

  - platform: template
    name: "Time Group 1 - End Minute"
    id: time_group_1_end_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48013, x);

  - platform: template
    name: "Time Group 1 - Power Limit"
    id: time_group_1_power_limit
    min_value: -10000
    max_value: 10000
    step: 100
    unit_of_measurement: "W"
    icon: "mdi:power-plug"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48014, x);

  - platform: template
    name: "Time Group 1 - Mode"
    id: time_group_1_mode
    min_value: 0
    max_value: 2
    step: 1
    icon: "mdi:cog"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48015, x);

  # Time Group 2 (offset +6)
  - platform: template
    name: "Time Group 2 - Start Hour"
    id: time_group_2_start_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48016, x);

  - platform: template
    name: "Time Group 2 - Start Minute"
    id: time_group_2_start_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48017, x);

  - platform: template
    name: "Time Group 2 - End Hour"
    id: time_group_2_end_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48018, x);

  - platform: template
    name: "Time Group 2 - End Minute"
    id: time_group_2_end_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48019, x);

  - platform: template
    name: "Time Group 2 - Power Limit"
    id: time_group_2_power_limit
    min_value: -10000
    max_value: 10000
    step: 100
    unit_of_measurement: "W"
    icon: "mdi:power-plug"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48020, x);

  - platform: template
    name: "Time Group 2 - Mode"
    id: time_group_2_mode
    min_value: 0
    max_value: 2
    step: 1
    icon: "mdi:cog"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48021, x);

  # Time Group 3
  - platform: template
    name: "Time Group 3 - Start Hour"
    id: time_group_3_start_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48022, x);

  - platform: template
    name: "Time Group 3 - Start Minute"
    id: time_group_3_start_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48023, x);

  - platform: template
    name: "Time Group 3 - End Hour"
    id: time_group_3_end_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48024, x);

  - platform: template
    name: "Time Group 3 - End Minute"
    id: time_group_3_end_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48025, x);

  - platform: template
    name: "Time Group 3 - Power Limit"
    id: time_group_3_power_limit
    min_value: -10000
    max_value: 10000
    step: 100
    unit_of_measurement: "W"
    icon: "mdi:power-plug"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48026, x);

  - platform: template
    name: "Time Group 3 - Mode"
    id: time_group_3_mode
    min_value: 0
    max_value: 2
    step: 1
    icon: "mdi:cog"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48027, x);

  # Time Group 4
  - platform: template
    name: "Time Group 4 - Start Hour"
    id: time_group_4_start_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48028, x);

  - platform: template
    name: "Time Group 4 - Start Minute"
    id: time_group_4_start_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48029, x);

  - platform: template
    name: "Time Group 4 - End Hour"
    id: time_group_4_end_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48030, x);

  - platform: template
    name: "Time Group 4 - End Minute"
    id: time_group_4_end_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48031, x);

  - platform: template
    name: "Time Group 4 - Power Limit"
    id: time_group_4_power_limit
    min_value: -10000
    max_value: 10000
    step: 100
    unit_of_measurement: "W"
    icon: "mdi:power-plug"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48032, x);

  - platform: template
    name: "Time Group 4 - Mode"
    id: time_group_4_mode
    min_value: 0
    max_value: 2
    step: 1
    icon: "mdi:cog"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48033, x);

  # Time Group 5
  - platform: template
    name: "Time Group 5 - Start Hour"
    id: time_group_5_start_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48034, x);

  - platform: template
    name: "Time Group 5 - Start Minute"
    id: time_group_5_start_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48035, x);

  - platform: template
    name: "Time Group 5 - End Hour"
    id: time_group_5_end_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48036, x);

  - platform: template
    name: "Time Group 5 - End Minute"
    id: time_group_5_end_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48037, x);

  - platform: template
    name: "Time Group 5 - Power Limit"
    id: time_group_5_power_limit
    min_value: -10000
    max_value: 10000
    step: 100
    unit_of_measurement: "W"
    icon: "mdi:power-plug"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48038, x);

  - platform: template
    name: "Time Group 5 - Mode"
    id: time_group_5_mode
    min_value: 0
    max_value: 2
    step: 1
    icon: "mdi:cog"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48039, x);

  # Time Group 6
  - platform: template
    name: "Time Group 6 - Start Hour"
    id: time_group_6_start_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48040, x);

  - platform: template
    name: "Time Group 6 - Start Minute"
    id: time_group_6_start_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-start"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48041, x);

  - platform: template
    name: "Time Group 6 - End Hour"
    id: time_group_6_end_hour
    min_value: 0
    max_value: 23
    step: 1
    unit_of_measurement: "h"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48042, x);

  - platform: template
    name: "Time Group 6 - End Minute"
    id: time_group_6_end_minute
    min_value: 0
    max_value: 59
    step: 1
    unit_of_measurement: "min"
    icon: "mdi:clock-end"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48043, x);

  - platform: template
    name: "Time Group 6 - Power Limit"
    id: time_group_6_power_limit
    min_value: -10000
    max_value: 10000
    step: 100
    unit_of_measurement: "W"
    icon: "mdi:power-plug"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48044, x);

  - platform: template
    name: "Time Group 6 - Mode"
    id: time_group_6_mode
    min_value: 0
    max_value: 2
    step: 1
    icon: "mdi:cog"
    optimistic: true
    set_action:
      - lambda: |-
          id(foxess_p3).write_single_register(48045, x);

# ────────────────────────────────────────────────
# TEMPLATE SENSORS – czytelne opisy trybu każdej grupy (opcjonalne)
# ────────────────────────────────────────────────
text_sensor:
  - platform: template
    name: "Time Group 1 Mode Text"
    update_interval: 10s
    lambda: |-
      auto mode = id(time_group_1_mode).state;
      if (mode == 0) return std::string("Wyłączony");
      if (mode == 1) return std::string("Ładowanie");
      if (mode == 2) return std::string("Rozładowywanie");
      return std::string("Nieznany");

  # Dodaj analogicznie dla Group 2–6 (skopiuj blok i zmień id(time_group_X_mode))
  # Przykład dla Group 6:
  - platform: template
    name: "Time Group 6 Mode Text"
    update_interval: 10s
    lambda: |-
      auto mode = id(time_group_6_mode).state;
      if (mode == 0) return std::string("Wyłączony");
      if (mode == 1) return std::string("Ładowanie");
      if (mode == 2) return std::string("Rozładowywanie");
      return std::string("Nieznany");
