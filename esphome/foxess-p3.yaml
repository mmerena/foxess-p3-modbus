# foxess-p3.yaml
# Pełna konfiguracja ESPHome dla FoxESS P3-10.0-SH (Modbus TCP)
# Slave ID: 247 (najczęściej w P3 komercyjnych)
# IP inwertera: zmień na swój (np. 192.168.1.10)
# ESP32 zalecany (dużo sensorów = dużo pamięci)

esphome:
  name: foxess-p3-modbus
  friendly_name: FoxESS P3-10.0-SH
  platform: ESP32
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

logger:
  level: INFO   # DEBUG jeśli chcesz zobaczyć surowe odpowiedzi Modbus

api:
  encryption:
    key: "Wygeneruj klucz w ESPHome Dashboard"

ota:
  platform: esphome
  password: !secret ota_password

time:
  - platform: homeassistant
    id: homeassistant_time

# Modbus TCP – połączenie z inwerterem
uart:
  # Jeśli masz RS485 → odkomentuj i dostosuj piny
  # tx_pin: GPIO17
  # rx_pin: GPIO16
  # baud_rate: 9600
  # parity: NONE

modbus:
  id: modbus_fox
  send_wait_time: 50ms

modbus_controller:
  - id: foxess_p3
    address: 247               # slave ID – przetestuj też 1 jeśli nie działa
    modbus_id: modbus_fox
    command_throttle: 150ms    # minimalny odstęp między zapytaniami
    setup_priority: -10

# ────────────────────────────────────────────────
# SENSORY – wszystkie kluczowe z PDF (holding registers)
# ────────────────────────────────────────────────

sensor:
  # 1. Informacje statyczne o inwerterze
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "FoxESS Model Name"
    register_type: holding
    address: 30000
    value_type: STRING
    raw_encode: HEXBYTES
    length: 16                 # 16 rejestrów = 32 znaki
    update_interval: 300s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "FoxESS Serial Number"
    register_type: holding
    address: 30016
    value_type: STRING
    raw_encode: HEXBYTES
    length: 16
    update_interval: 300s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "FoxESS Master Version"
    register_type: holding
    address: 36001
    value_type: U_WORD
    update_interval: 300s

  # 2. BMS1 – podstawowe + szczegółowe (z PDF str. 6–7)
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Connection Status"
    register_type: holding
    address: 37002
    value_type: U_WORD
    update_interval: 30s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Voltage"
    register_type: holding
    address: 37609
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1          # gain 10
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Current"
    register_type: holding
    address: 37610
    value_type: S_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Ambient Temperature"
    register_type: holding
    address: 37611
    value_type: S_WORD
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 30s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 SoC"
    register_type: holding
    address: 37612
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Max Temperature"
    register_type: holding
    address: 37617
    value_type: S_WORD
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Min Temperature"
    register_type: holding
    address: 37618
    value_type: S_WORD
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Max Cell Voltage"
    register_type: holding
    address: 37619
    value_type: U_WORD
    unit_of_measurement: "mV"
    accuracy_decimals: 0
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Min Cell Voltage"
    register_type: holding
    address: 37620
    value_type: U_WORD
    unit_of_measurement: "mV"
    accuracy_decimals: 0
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 SOH"
    register_type: holding
    address: 37624
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Remain Energy"
    register_type: holding
    address: 37632
    value_type: U_WORD
    unit_of_measurement: "Wh"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1          # gain 0.1
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 FCC Capacity"
    register_type: holding
    address: 37633
    value_type: U_WORD
    unit_of_measurement: "Ah"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 300s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Design Energy"
    register_type: holding
    address: 37635
    value_type: U_WORD
    unit_of_measurement: "Wh"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 300s

  # BMS1 Faults (bitfields – osobne sensory dla najważniejszych bitów)
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Fault1 Raw"
    register_type: holding
    address: 37626
    value_type: U_WORD
    update_interval: 30s

  # Przykład template dla bitu (dodaj w HA jako template sensor)
  # BMS1 Fault – Over Voltage: {{ states('sensor.bms1_fault1_raw') | int | bitand(1) > 0 }}

  # BMS2 – podstawowe (analogicznie do BMS1)
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS2 Connection Status"
    register_type: holding
    address: 37700
    value_type: U_WORD
    update_interval: 30s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS2 Voltage"
    register_type: holding
    address: 38307
    value_type: U_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS2 SoC"
    register_type: holding
    address: 38310
    value_type: U_WORD
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 10s

  # 3. Meter1 / Grid phases (trójfazowy pomiar sieci – kluczowy dla P3)
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Grid R Phase Voltage"
    register_type: holding
    address: 38802
    value_type: S_DWORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1          # gain 10
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Grid S Phase Voltage"
    register_type: holding
    address: 38804
    value_type: S_DWORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Grid T Phase Voltage"
    register_type: holding
    address: 38806
    value_type: S_DWORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Grid Combined Active Power"
    register_type: holding
    address: 38814
    value_type: S_DWORD
    unit_of_measurement: "W"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 5s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Grid Frequency"
    register_type: holding
    address: 38846
    value_type: S_DWORD
    unit_of_measurement: "Hz"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01         # gain 100
    update_interval: 10s

  # 4. PV – do 4 stringów (P3 może mieć więcej – dodaj kolejne jeśli potrzeba)
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Number of PV Strings"
    register_type: holding
    address: 39051
    value_type: U_WORD
    update_interval: 300s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV1 Voltage"
    register_type: holding
    address: 39070
    value_type: S_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV1 Current"
    register_type: holding
    address: 39071
    value_type: S_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01         # gain 100
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV2 Voltage"
    register_type: holding
    address: 39072
    value_type: S_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV2 Current"
    register_type: holding
    address: 39073
    value_type: S_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV3 Voltage"
    register_type: holding
    address: 39074
    value_type: S_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV3 Current"
    register_type: holding
    address: 39075
    value_type: S_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV4 Voltage"
    register_type: holding
    address: 39076
    value_type: S_WORD
    unit_of_measurement: "V"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "PV4 Current"
    register_type: holding
    address: 39077
    value_type: S_WORD
    unit_of_measurement: "A"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 10s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Total PV Input Power"
    register_type: holding
    address: 39118
    value_type: S_DWORD
    unit_of_measurement: "kW"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    update_interval: 5s

  # 5. Inwerter / Load / EPS – kluczowe moce
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Inverter Active Power"
    register_type: holding
    address: 39134
    value_type: S_DWORD
    unit_of_measurement: "kW"
    accuracy_decimals: 3
    filters:
      - multiply: 0.001
    update_interval: 5s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Load Combined Power"
    register_type: holding
    address: 39225
    value_type: S_DWORD
    unit_of_measurement: "W"
    accuracy_decimals: 0
    update_interval: 5s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "EPS Combined Power"
    register_type: holding
    address: 39216
    value_type: S_DWORD
    unit_of_measurement: "W"
    accuracy_decimals: 0
    update_interval: 10s

  # 6. Energie kumulacyjne
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Cumulative Power Generation"
    register_type: holding
    address: 39149
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01         # gain 100
    update_interval: 60s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Total PV Energy"
    register_type: holding
    address: 39601
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 300s

  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "Daily PV Energy"
    register_type: holding
    address: 39603
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    update_interval: 300s

# ────────────────────────────────────────────────
# Dodatkowe opcje (opcjonalne)
# ────────────────────────────────────────────────

# text_sensor – do wyświetlania surowego modelu jako tekst
text_sensor:
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "FoxESS Model Raw"
    register_type: holding
    address: 30000
    value_type: STRING
    raw_encode: HEXBYTES
    length: 16
    update_interval: 300s

# binary_sensor – przykład dla statusu BMS1
binary_sensor:
  - platform: modbus_controller
    modbus_controller_id: foxess_p3
    name: "BMS1 Online"
    register_type: holding
    address: 37002
    value_type: U_WORD
    on_state:
      then:
        - lambda: |-
            id(bms1_status_led).turn_on_if(x == 1);
            id(bms1_status_led).turn_off_if(x == 0);
    update_interval: 30s
