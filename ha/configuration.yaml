# configuration.yaml lub packages/foxess-p3-modbus.yaml
# Pełna integracja Modbus TCP dla FoxESS P3-10.0-SH (komercyjny hybrydowy)
# Dokument: FOX commercial inverter Modbus V1.05.03.00 (2025-01-15)
# Zawiera: wszystkie sensory RO, binary sensors, switches, numbers RW, 6 grup czasowych, templates i automatyzację przykładową
# IP inwertera: 192.168.1.100 – zmień na swój
# Slave ID: 247 – przetestuj 1 jeśli timeout
# Po dodaniu: restart HA, sprawdź logi na błędy Modbus

modbus:
  - name: foxess_p3
    type: tcp
    host: 192.168.1.100
    port: 502
    timeout: 5
    delay: 0
    message_wait_milliseconds: 30

    sensors:
      # ────────────────────────────────────────────────
      # 1. Informacje o modelu i wersjach (statyczne)
      # ────────────────────────────────────────────────
      - name: FoxESS Model Name
        slave: 247
        address: 30000
        data_type: string
        count: 16
        scan_interval: 300

      - name: FoxESS Serial Number
        slave: 247
        address: 30016
        data_type: string
        count: 16
        scan_interval: 300

      - name: FoxESS MFG ID
        slave: 247
        address: 30032
        data_type: string
        count: 16
        scan_interval: 300

      - name: FoxESS Master Version
        slave: 247
        address: 36001
        data_type: uint16
        scan_interval: 300

      - name: FoxESS Slave Version
        slave: 247
        address: 36002
        data_type: uint16
        scan_interval: 300

      - name: FoxESS Manager Version
        slave: 247
        address: 36003
        data_type: uint16
        scan_interval: 300

      # Meter1 / Meter2 – podstawowe
      - name: Meter1 SN
        slave: 247
        address: 36100
        data_type: string
        count: 16
        scan_interval: 300

      - name: Meter1 MFG ID
        slave: 247
        address: 36116
        data_type: string
        count: 16
        scan_interval: 300

      - name: Meter1 Type
        slave: 247
        address: 36132
        data_type: string
        count: 16
        scan_interval: 300

      - name: Meter1 Version
        slave: 247
        address: 36148
        data_type: string
        count: 1
        scan_interval: 300

      - name: Meter2 SN
        slave: 247
        address: 36200
        data_type: string
        count: 16
        scan_interval: 300

      # ────────────────────────────────────────────────
      # 2. BMS1 – pełna lista
      # ────────────────────────────────────────────────
      - name: BMS1 Connection Status
        slave: 247
        address: 37002
        data_type: uint16
        scan_interval: 10

      - name: BMS1 Voltage
        slave: 247
        address: 37609
        data_type: uint16
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 10

      - name: BMS1 Current
        slave: 247
        address: 37610
        data_type: int16
        scale: 0.1
        unit_of_measurement: A
        precision: 1
        scan_interval: 10

      - name: BMS1 Ambient Temperature
        slave: 247
        address: 37611
        data_type: int16
        scale: 0.1
        unit_of_measurement: "°C"
        precision: 1
        scan_interval: 30

      - name: BMS1 SoC
        slave: 247
        address: 37612
        data_type: uint16
        unit_of_measurement: "%"
        precision: 0
        scan_interval: 10

      - name: BMS1 Max Temperature
        slave: 247
        address: 37617
        data_type: int16
        scale: 0.1
        unit_of_measurement: "°C"
        precision: 1
        scan_interval: 30

      - name: BMS1 Min Temperature
        slave: 247
        address: 37618
        data_type: int16
        scale: 0.1
        unit_of_measurement: "°C"
        precision: 1
        scan_interval: 30

      - name: BMS1 Max Cell Voltage
        slave: 247
        address: 37619
        data_type: uint16
        unit_of_measurement: mV
        precision: 0
        scan_interval: 30

      - name: BMS1 Min Cell Voltage
        slave: 247
        address: 37620
        data_type: uint16
        unit_of_measurement: mV
        precision: 0
        scan_interval: 30

      - name: BMS1 SOH
        slave: 247
        address: 37624
        data_type: uint16
        unit_of_measurement: "%"
        precision: 0
        scan_interval: 60

      - name: BMS1 Remain Energy
        slave: 247
        address: 37632
        data_type: uint16
        scale: 0.1
        unit_of_measurement: Wh
        precision: 1
        scan_interval: 60

      - name: BMS1 FCC Capacity
        slave: 247
        address: 37633
        data_type: uint16
        scale: 0.1
        unit_of_measurement: Ah
        precision: 1
        scan_interval: 300

      - name: BMS1 Design Energy
        slave: 247
        address: 37635
        data_type: uint16
        scale: 0.1
        unit_of_measurement: Wh
        precision: 1
        scan_interval: 300

      # BMS1 Faults Raw (użyj template do bitów)
      - name: BMS1 Fault1 Raw
        slave: 247
        address: 37626
        data_type: uint16
        scan_interval: 30

      - name: BMS1 Fault2 Raw
        slave: 247
        address: 37627
        data_type: uint16
        scan_interval: 30

      # ... (dodaj Fault3–6 analogicznie)

      # BMS2 – podstawowe
      - name: BMS2 Connection Status
        slave: 247
        address: 37700
        data_type: uint16
        scan_interval: 10

      - name: BMS2 Voltage
        slave: 247
        address: 38307
        data_type: uint16
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 10

      - name: BMS2 Current
        slave: 247
        address: 38308
        data_type: int16
        scale: 0.1
        unit_of_measurement: A
        precision: 1
        scan_interval: 10

      - name: BMS2 SoC
        slave: 247
        address: 38310
        data_type: uint16
        unit_of_measurement: "%"
        precision: 0
        scan_interval: 10

      - name: BMS2 SOH
        slave: 247
        address: 38322
        data_type: uint16
        unit_of_measurement: "%"
        precision: 0
        scan_interval: 60

      - name: BMS2 Remain Energy
        slave: 247
        address: 38330
        data_type: uint16
        scale: 0.1
        unit_of_measurement: Wh
        precision: 1
        scan_interval: 60

      # ────────────────────────────────────────────────
      # 3. Meter1/CT1 – pełna trójfazowa sieć
      # ────────────────────────────────────────────────
      - name: Meter1 Connection State
        slave: 247
        address: 38801
        data_type: uint16
        scan_interval: 10

      - name: Grid R Phase Voltage
        slave: 247
        address: 38802
        data_type: int32
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 5

      - name: Grid S Phase Voltage
        slave: 247
        address: 38804
        data_type: int32
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 5

      - name: Grid T Phase Voltage
        slave: 247
        address: 38806
        data_type: int32
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 5

      - name: Grid R Phase Current
        slave: 247
        address: 38808
        data_type: int32
        scale: 0.001
        unit_of_measurement: A
        precision: 3
        scan_interval: 5

      - name: Grid S Phase Current
        slave: 247
        address: 38810
        data_type: int32
        scale: 0.001
        unit_of_measurement: A
        precision: 3
        scan_interval: 5

      - name: Grid T Phase Current
        slave: 247
        address: 38812
        data_type: int32
        scale: 0.001
        unit_of_measurement: A
        precision: 3
        scan_interval: 5

      - name: Grid Combined Active Power
        slave: 247
        address: 38814
        data_type: int32
        scale: 0.1
        unit_of_measurement: W
        precision: 1
        scan_interval: 5

      - name: Grid R Phase Active Power
        slave: 247
        address: 38816
        data_type: int32
        scale: 0.1
        unit_of_measurement: W
        precision: 1
        scan_interval: 5

      - name: Grid S Phase Active Power
        slave: 247
        address: 38818
        data_type: int32
        scale: 0.1
        unit_of_measurement: W
        precision: 1
        scan_interval: 5

      - name: Grid T Phase Active Power
        slave: 247
        address: 38820
        data_type: int32
        scale: 0.1
        unit_of_measurement: W
        precision: 1
        scan_interval: 5

      - name: Grid Frequency
        slave: 247
        address: 38846
        data_type: int32
        scale: 0.01
        unit_of_measurement: Hz
        precision: 2
        scan_interval: 10

      # ────────────────────────────────────────────────
      # 4. PV – liczba stringów + PV1–4 + total power
      # ────────────────────────────────────────────────
      - name: Number of PV Strings
        slave: 247
        address: 39051
        data_type: uint16
        scan_interval: 60

      - name: PV1 Voltage
        slave: 247
        address: 39070
        data_type: int16
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 10

      - name: PV1 Current
        slave: 247
        address: 39071
        data_type: int16
        scale: 0.01
        unit_of_measurement: A
        precision: 2
        scan_interval: 10

      - name: PV2 Voltage
        slave: 247
        address: 39072
        data_type: int16
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 10

      - name: PV2 Current
        slave: 247
        address: 39073
        data_type: int16
        scale: 0.01
        unit_of_measurement: A
        precision: 2
        scan_interval: 10

      - name: PV3 Voltage
        slave: 247
        address: 39074
        data_type: int16
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 10

      - name: PV3 Current
        slave: 247
        address: 39075
        data_type: int16
        scale: 0.01
        unit_of_measurement: A
        precision: 2
        scan_interval: 10

      - name: PV4 Voltage
        slave: 247
        address: 39076
        data_type: int16
        scale: 0.1
        unit_of_measurement: V
        precision: 1
        scan_interval: 10

      - name: PV4 Current
        slave: 247
        address: 39077
        data_type: int16
        scale: 0.01
        unit_of_measurement: A
        precision: 2
        scan_interval: 10

      - name: Total PV Input Power
        slave: 247
        address: 39118
        data_type: int32
        scale: 0.001
        unit_of_measurement: kW
        precision: 3
        scan_interval: 5

      # ────────────────────────────────────────────────
      # 5. Inwerter / Load / EPS / Runtime
      # ────────────────────────────────────────────────
      - name: Inverter Active Power
        slave: 247
        address: 39134
        data_type: int32
        scale: 0.001
        unit_of_measurement: kW
        precision: 3
        scan_interval: 5

      - name: Load Combined Power
        slave: 247
        address: 39225
        data_type: int32
        scale: 1
        unit_of_measurement: W
        precision: 0
        scan_interval: 5

      - name: EPS Combined Power
        slave: 247
        address: 39216
        data_type: int32
        scale: 1
        unit_of_measurement: W
        precision: 0
        scan_interval: 10

      - name: Cumulative Power Generation
        slave: 247
        address: 39149
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        precision: 2
        scan_interval: 60

      # ────────────────────────────────────────────────
      # 6. Energie kumulacyjne i dzienne
      # ────────────────────────────────────────────────
      - name: Total PV Energy
        slave: 247
        address: 39601
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        precision: 2
        scan_interval: 300

      - name: Daily PV Energy
        slave: 247
        address: 39603
        data_type: uint32
        scale: 0.01
        unit_of_measurement: kWh
        precision: 2
        scan_interval: 300

      # ────────────────────────────────────────────────
      # BINARY SENSORS – połączenia
      # ────────────────────────────────────────────────
    binary_sensors:
      - name: BMS1 Online
        slave: 247
        address: 37002
        input_type: holding
        scan_interval: 10

      - name: BMS2 Online
        slave: 247
        address: 37700
        input_type: holding
        scan_interval: 10

      - name: Meter1 Connected
        slave: 247
        address: 38801
        input_type: holding
        scan_interval: 10

      # ────────────────────────────────────────────────
      # SWITCHES – RW flagi
      # ────────────────────────────────────────────────
    switches:
      - name: Force Charge Battery
        slave: 247
        address: 37636
        value_type: uint16
        command_on: 1
        command_off: 0
        state_on: 1
        state_off: 0
        icon: "mdi:battery-charging-100"
        optimistic: true

      - name: Battery Connect Enable
        slave: 247
        address: 45007
        value_type: uint16
        command_on: 1
        command_off: 0
        state_on: 1
        state_off: 0
        icon: "mdi:battery-connected"
        optimistic: true

      - name: Remote Control Enable
        slave: 247
        address: 46001
        value_type: uint16
        command_on: 1
        command_off: 0
        state_on: 1
        state_off: 0
        icon: "mdi:remote"
        optimistic: true

      - name: Time Mode Enable
        slave: 247
        address: 48000
        value_type: uint16
        command_on: 1
        command_off: 0
        state_on: 1
        state_off: 0
        icon: "mdi:clock"
        optimistic: true

      - name: MPPT Enable
        slave: 247
        address: 49210
        value_type: uint16
        command_on: 1
        command_off: 0
        state_on: 1
        state_off: 0
        icon: "mdi:solar-power"
        optimistic: true

      # ────────────────────────────────────────────────
      # NUMBERS – RW limity + grupy czasowe
      # ────────────────────────────────────────────────
    numbers:
      - name: Battery Min SoC
        slave: 247
        address: 46609
        data_type: uint16
        min_value: 10
        max_value: 100
        step: 1
        unit_of_measurement: "%"
        icon: "mdi:battery-low"
        mode: box

      - name: Battery Max SoC
        slave: 247
        address: 46610
        data_type: uint16
        min_value: 10
        max_value: 100
        step: 1
        unit_of_measurement: "%"
        icon: "mdi:battery-high"
        mode: box

      - name: Battery Min SoC OnGrid
        slave: 247
        address: 46611
        data_type: uint16
        min_value: 10
        max_value: 100
        step: 1
        unit_of_measurement: "%"
        icon: "mdi:battery-sync"
        mode: box

      - name: Import Power Limit
        slave: 247
        address: 46501
        data_type: int32
        min_value: 0
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:transmission-tower-import"
        mode: box

      - name: Export Power Limit
        slave: 247
        address: 46616
        data_type: int32
        min_value: 0
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:transmission-tower-export"
        mode: box

      - name: Battery Max Charge Current
        slave: 247
        address: 46607
        data_type: int16
        min_value: 0
        max_value: 200
        step: 1
        unit_of_measurement: A
        icon: "mdi:battery-charging"
        mode: box

      - name: Battery Max Discharge Current
        slave: 247
        address: 46608
        data_type: int16
        min_value: 0
        max_value: 200
        step: 1
        unit_of_measurement: A
        icon: "mdi:battery-arrow-down"
        mode: box

      - name: Grid Point Power Limit
        slave: 247
        address: 49136
        data_type: int32
        min_value: -5000
        max_value: 5000
        step: 100
        unit_of_measurement: W
        icon: "mdi:power-plug"
        mode: box

      # ────────────────────────────────────────────────
      # 6 GRUP CZASOWYCH – PEŁNA KONFIGURACJA
      # ────────────────────────────────────────────────

      # Time Group 1
      - name: Time Group 1 - Start Hour
        slave: 247
        address: 48010
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 1 - Start Minute
        slave: 247
        address: 48011
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 1 - End Hour
        slave: 247
        address: 48012
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 1 - End Minute
        slave: 247
        address: 48013
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 1 - Power Limit
        slave: 247
        address: 48014
        data_type: int32
        min_value: -10000
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:power-plug"
        mode: box

      - name: Time Group 1 - Mode
        slave: 247
        address: 48015
        data_type: uint16
        min_value: 0
        max_value: 2
        step: 1
        icon: "mdi:cog"
        mode: box

      # Time Group 2
      - name: Time Group 2 - Start Hour
        slave: 247
        address: 48016
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 2 - Start Minute
        slave: 247
        address: 48017
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 2 - End Hour
        slave: 247
        address: 48018
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 2 - End Minute
        slave: 247
        address: 48019
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 2 - Power Limit
        slave: 247
        address: 48020
        data_type: int32
        min_value: -10000
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:power-plug"
        mode: box

      - name: Time Group 2 - Mode
        slave: 247
        address: 48021
        data_type: uint16
        min_value: 0
        max_value: 2
        step: 1
        icon: "mdi:cog"
        mode: box

      # Time Group 3
      - name: Time Group 3 - Start Hour
        slave: 247
        address: 48022
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 3 - Start Minute
        slave: 247
        address: 48023
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 3 - End Hour
        slave: 247
        address: 48024
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 3 - End Minute
        slave: 247
        address: 48025
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 3 - Power Limit
        slave: 247
        address: 48026
        data_type: int32
        min_value: -10000
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:power-plug"
        mode: box

      - name: Time Group 3 - Mode
        slave: 247
        address: 48027
        data_type: uint16
        min_value: 0
        max_value: 2
        step: 1
        icon: "mdi:cog"
        mode: box

      # Time Group 4
      - name: Time Group 4 - Start Hour
        slave: 247
        address: 48028
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 4 - Start Minute
        slave: 247
        address: 48029
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 4 - End Hour
        slave: 247
        address: 48030
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 4 - End Minute
        slave: 247
        address: 48031
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 4 - Power Limit
        slave: 247
        address: 48032
        data_type: int32
        min_value: -10000
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:power-plug"
        mode: box

      - name: Time Group 4 - Mode
        slave: 247
        address: 48033
        data_type: uint16
        min_value: 0
        max_value: 2
        step: 1
        icon: "mdi:cog"
        mode: box

      # Time Group 5
      - name: Time Group 5 - Start Hour
        slave: 247
        address: 48034
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 5 - Start Minute
        slave: 247
        address: 48035
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 5 - End Hour
        slave: 247
        address: 48036
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 5 - End Minute
        slave: 247
        address: 48037
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 5 - Power Limit
        slave: 247
        address: 48038
        data_type: int32
        min_value: -10000
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:power-plug"
        mode: box

      - name: Time Group 5 - Mode
        slave: 247
        address: 48039
        data_type: uint16
        min_value: 0
        max_value: 2
        step: 1
        icon: "mdi:cog"
        mode: box

      # Time Group 6
      - name: Time Group 6 - Start Hour
        slave: 247
        address: 48040
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 6 - Start Minute
        slave: 247
        address: 48041
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-start"
        mode: box

      - name: Time Group 6 - End Hour
        slave: 247
        address: 48042
        data_type: uint16
        min_value: 0
        max_value: 23
        step: 1
        unit_of_measurement: h
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 6 - End Minute
        slave: 247
        address: 48043
        data_type: uint16
        min_value: 0
        max_value: 59
        step: 1
        unit_of_measurement: min
        icon: "mdi:clock-end"
        mode: box

      - name: Time Group 6 - Power Limit
        slave: 247
        address: 48044
        data_type: int32
        min_value: -10000
        max_value: 10000
        step: 100
        unit_of_measurement: W
        icon: "mdi:power-plug"
        mode: box

      - name: Time Group 6 - Mode
        slave: 247
        address: 48045
        data_type: uint16
        min_value: 0
        max_value: 2
        step: 1
        icon: "mdi:cog"
        mode: box

      # ────────────────────────────────────────────────
      # Pozostałe numbers (Min/Max SoC, Limits itp.) – bez zmian z poprzedniej wersji
      # ────────────────────────────────────────────────

# ────────────────────────────────────────────────
# TEMPLATE SENSORS – tekstowe opisy dla Mode w grupach czasowych
# ────────────────────────────────────────────────
template:
  - sensor:
      - name: Time Group 1 Mode Text
        state: >
          {% set m = states('number.time_group_1_mode') | int(0) %}
          {% if m == 0 %}Wyłączony
          {% elif m == 1 %}Ładowanie
          {% elif m == 2 %}Rozładowywanie
          {% else %}Nieznany{% endif %}
        icon: "mdi:cog"

      - name: Time Group 2 Mode Text
        state: >
          {% set m = states('number.time_group_2_mode') | int(0) %}
          {% if m == 0 %}Wyłączony
          {% elif m == 1 %}Ładowanie
          {% elif m == 2 %}Rozładowywanie
          {% else %}Nieznany{% endif %}
        icon: "mdi:cog"

      - name: Time Group 3 Mode Text
        state: >
          {% set m = states('number.time_group_3_mode') | int(0) %}
          {% if m == 0 %}Wyłączony
          {% elif m == 1 %}Ładowanie
          {% elif m == 2 %}Rozładowywanie
          {% else %}Nieznany{% endif %}
        icon: "mdi:cog"

      - name: Time Group 4 Mode Text
        state: >
          {% set m = states('number.time_group_4_mode') | int(0) %}
          {% if m == 0 %}Wyłączony
          {% elif m == 1 %}Ładowanie
          {% elif m == 2 %}Rozładowywanie
          {% else %}Nieznany{% endif %}
        icon: "mdi:cog"

      - name: Time Group 5 Mode Text
        state: >
          {% set m = states('number.time_group_5_mode') | int(0) %}
          {% if m == 0 %}Wyłączony
          {% elif m == 1 %}Ładowanie
          {% elif m == 2 %}Rozładowywanie
          {% else %}Nieznany{% endif %}
        icon: "mdi:cog"

      - name: Time Group 6 Mode Text
        state: >
          {% set m = states('number.time_group_6_mode') | int(0) %}
          {% if m == 0 %}Wyłączony
          {% elif m == 1 %}Ładowanie
          {% elif m == 2 %}Rozładowywanie
          {% else %}Nieznany{% endif %}
        icon: "mdi:cog"

# ────────────────────────────────────────────────
# AUTOMATION – przykład nocnego ładowania
# ────────────────────────────────────────────────
automation:
  - alias: Nocne ładowanie baterii (Group 1: 22:00–06:00, 5 kW charge)
    trigger:
      - platform: time
        at: "21:55:00"  # 5 min przed, aby zdążyć zapisać
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.time_mode_enable

      - service: number.set_value
        target:
          entity_id: number.time_group_1_start_hour
        data:
          value: 22

      - service: number.set_value
        target:
          entity_id: number.time_group_1_start_minute
        data:
          value: 0

      - service: number.set_value
        target:
          entity_id: number.time_group_1_end_hour
        data:
          value: 6

      - service: number.set_value
        target:
          entity_id: number.time_group_1_end_minute
        data:
          value: 0

      - service: number.set_value
        target:
          entity_id: number.time_group_1_power_limit
        data:
          value: 5000

      - service: number.set_value
        target:
          entity_id: number.time_group_1_mode
        data:
          value: 1  # 1 = charge

    mode: single
